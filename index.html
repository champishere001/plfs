<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>PLFS 2026 | Admin Reports</title>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root { --bg: #0d1117; --card: #161b22; --border: #30363d; --accent: #58a6ff; --text: #c9d1d9; --v1: #2ea043; }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: var(--bg); color: var(--text); padding: 30px; margin: 0; }
        .admin-layout { display: grid; grid-template-columns: 350px 1fr; gap: 20px; }
        .card { background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 20px; margin-bottom: 20px; }
        h1, h2 { color: var(--accent); margin-top: 0; font-size: 20px; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th { text-align: left; font-size: 11px; color: #8b949e; padding: 10px; border-bottom: 1px solid var(--border); }
        td { padding: 10px; border-bottom: 1px solid var(--border); font-size: 13px; }
        .btn { padding: 12px; border-radius: 8px; border: none; font-weight: bold; cursor: pointer; background: var(--accent); color: #000; width: 100%; margin-bottom: 10px; }
        .progress-bar { height: 8px; background: #30363d; border-radius: 10px; overflow: hidden; flex: 1; margin-right: 10px; }
        .progress-fill { height: 100%; background: var(--v1); transition: 0.3s; }
    </style>
</head>
<body>

<div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 25px;">
    <h1>Operations Command Center</h1>
    <button class="btn" style="width:auto" onclick="location.href='index.html'">Return to Roster</button>
</div>

<div class="admin-layout">
    <div class="sidebar-tools">
        <div class="card">
            <h2>Import Data</h2>
            <button class="btn" onclick="document.getElementById('xlRural').click()">+ Upload Rural Excel</button>
            <button class="btn" onclick="document.getElementById('xlUrban').click()">+ Upload Urban Excel</button>
            <input type="file" id="xlRural" hidden multiple onchange="handleExcel(this, 'Rural')">
            <input type="file" id="xlUrban" hidden multiple onchange="handleExcel(this, 'Urban')">
            <hr style="border:0; border-top:1px solid var(--border); margin:15px 0">
            <button class="btn" style="background:var(--v1); color:white" onclick="syncCloud()">Push Local to Cloud</button>
            <button class="btn" style="background:#f85149; color:white" onclick="wipeData()">Clear All Data</button>
        </div>
        
        <div class="card">
            <h2>Summary Stats</h2>
            <div id="statsSummary" style="font-size: 14px; line-height: 2;"></div>
        </div>
    </div>

    <div class="main-reports">
        <div class="card">
            <h2>State-wise Target vs Assigned</h2>
            <canvas id="mainChart" style="max-height: 300px;"></canvas>
        </div>

        <div class="card">
            <h2>Hierarchy Progress (RO > SRO)</h2>
            <table>
                <thead>
                    <tr><th>Region / SRO</th><th>Target</th><th>Assigned</th><th>Progress</th></tr>
                </thead>
                <tbody id="progressTable"></tbody>
            </table>
        </div>
    </div>
</div>

<script>
    const config = { apiKey: "AIzaSyB6fQ8n4qyG-TfVdAqWtDped17bMYTZSgI", authDomain: "action-plan-62fae.firebaseapp.com", databaseURL: "https://action-plan-62fae-default-rtdb.firebaseio.com", projectId: "action-plan-62fae" };
    firebase.initializeApp(config);
    const db = firebase.database();

    let master = JSON.parse(localStorage.getItem('plfs_master')) || [];
    let myChart = null;

    function runReports() {
        const table = document.getElementById('progressTable');
        const stats = document.getElementById('statsSummary');
        const reportData = {};
        let total = master.length, done = 0;

        master.forEach(d => {
            const key = `${d.state} - ${d.sro}`;
            if(!reportData[key]) reportData[key] = { total: 0, done: 0 };
            reportData[key].total++; 
            if(d.date) { reportData[key].done++; done++; }
        });

        stats.innerHTML = `Total FSUs: <b>${total}</b><br>Assigned: <b>${done}</b><br>Pending: <b>${total - done}</b>`;

        table.innerHTML = Object.keys(reportData).sort().map(k => {
            const p = Math.round((reportData[k].done/reportData[k].total)*100) || 0;
            return `<tr><td><b>${k}</b></td><td>${reportData[k].total}</td><td>${reportData[k].done}</td><td style="display:flex; align-items:center"><div class="progress-bar"><div class="progress-fill" style="width:${p}%"></div></div>${p}%</td></tr>`;
        }).join('');

        updateChart();
    }

    function updateChart() {
        const ctx = document.getElementById('mainChart').getContext('2d');
        const states = [...new Set(master.map(m => m.state))];
        const assigned = states.map(s => master.filter(m => m.state === s && m.date).length);
        const total = states.map(s => master.filter(m => m.state === s).length);

        if(myChart) myChart.destroy();
        myChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: states,
                datasets: [
                    { label: 'Assigned', data: assigned, backgroundColor: '#58a6ff' },
                    { label: 'Remaining', data: total.map((t,i) => t - assigned[i]), backgroundColor: '#30363d' }
                ]
            },
            options: { responsive: true, scales: { x: { stacked: true }, y: { stacked: true } } }
        });
    }

    async function handleExcel(input, sector) {
        const files = Array.from(input.files);
        for(let file of files) {
            let state = file.name.split('.')[0].split('_').pop().trim();
            const data = new Uint8Array(await file.arrayBuffer());
            const rows = XLSX.utils.sheet_to_json(XLSX.read(data, {type:'array'}).Sheets[XLSX.read(data, {type:'array'}).SheetNames[0]], {header:1, range:7});
            rows.slice(1).forEach(cols => {
                let fsu, mCode, sro, loc;
                if(sector === 'Urban') { fsu=cols[3]; mCode=cols[4]; sro=cols[5]; loc=cols[8]; }
                else { fsu=cols[4]; mCode=cols[5]; sro=cols[6]; loc=cols[10]; }
                if(fsu) {
                    const startMonth = (parseInt(mCode) >= 13) ? (parseInt(mCode) - 13) : (parseInt(mCode)-1);
                    for(let i = 0; i < 4; i++) {
                        let curMonth = (startMonth + i) % 12;
                        let uid = `${state}_${fsu}_M${curMonth}_V${i+1}`;
                        if(!master.find(m => m.uid === uid)) master.push({ uid, fsu, state, sector, sro: String(sro).toUpperCase(), monthIdx: curMonth, location: loc || "---", enumerator: "", visitNum: i+1 });
                    }
                }
            });
        }
        localStorage.setItem('plfs_master', JSON.stringify(master));
        runReports();
    }

    async function syncCloud() {
        const grouped = {};
        master.forEach(item => { if (!grouped[item.state]) grouped[item.state] = {}; grouped[item.state][item.uid] = item; });
        await db.ref(`plfs_roster`).update(grouped);
        alert("Cloud updated successfully.");
    }

    function wipeData() { if(confirm("Permanently delete all data?")) { localStorage.clear(); location.reload(); } }
    
    runReports();
</script>
</body>
</html>
